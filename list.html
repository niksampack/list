<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kunden-Management App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Style for Autocomplete Dropdown */
        .suggestions-list {
            position: absolute;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            z-index: 50;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-top: 2px;
        }
        .suggestions-list li {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
        }
        .suggestions-list li:hover {
            background-color: #ebf8ff;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">

    <nav class="bg-indigo-700 p-4 shadow-lg text-white sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold"><i class="fas fa-cloud mr-2"></i>LieferApp Online</h1>
            <div id="statusIndicator" class="text-xs bg-yellow-500 py-1 px-3 rounded-full animate-pulse">Verbinden...</div>
        </div>
    </nav>

    <div class="container mx-auto p-4 md:p-8">
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-8 border-t-4 border-indigo-500 relative">
            <h2 class="text-2xl font-bold mb-6 text-gray-700">Neuen Kunden anlegen</h2>
            
            <form id="clientForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <div class="relative">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Name des Restaurants</label>
                    <input type="text" id="restaurant" autocomplete="off" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder-gray-400" placeholder="Tippen zum Suchen...">
                    <ul id="suggestions" class="suggestions-list hidden"></ul>
                </div>

                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Name des Kunden</label>
                    <input type="text" id="name" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>

                <div class="md:col-span-2">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Adresse</label>
                    <input type="text" id="address" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-50">
                </div>

                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Telefonnummer</label>
                    <input type="text" id="phone" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-50">
                </div>

                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Ansprechpartner / Referenz</label>
                    <input type="text" id="referer" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>

                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Liefertag</label>
                    <select id="day" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white">
                        <option value="Montag">Montag</option>
                        <option value="Dienstag">Dienstag</option>
                        <option value="Mittwoch">Mittwoch</option>
                        <option value="Donnerstag">Donnerstag</option>
                        <option value="Freitag">Freitag</option>
                        <option value="Samstag">Samstag</option>
                        <option value="Sonntag">Sonntag</option>
                    </select>
                </div>

                <div class="md:col-span-2 mt-4">
                    <button type="submit" id="submitBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex justify-center items-center">
                        <i class="fas fa-plus-circle mr-2"></i> Speichern (Server)
                    </button>
                </div>
            </form>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6 border-t-4 border-green-500">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-700 mb-4 md:mb-0">Kundenliste</h2>
                <div class="flex gap-2">
                    <button onclick="exportCSV()" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded shadow flex items-center">
                        <i class="fas fa-file-excel mr-2"></i> CSV
                    </button>
                    <button onclick="exportPDF()" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded shadow flex items-center">
                        <i class="fas fa-file-pdf mr-2"></i> PDF
                    </button>
                </div>
            </div>

            <div class="mb-4 relative">
                <input type="text" id="searchInput" placeholder="Suche in der Liste..." class="w-full pl-10 pr-4 py-2 border rounded-lg text-gray-700 focus:outline-none focus:border-indigo-500">
                <div class="absolute top-0 left-0 pt-2 pl-3">
                    <i class="fas fa-search text-gray-400"></i>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full table-auto" id="dataTable">
                    <thead class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                        <tr>
                            <th class="py-3 px-6 text-left">Kunde</th>
                            <th class="py-3 px-6 text-left">Restaurant</th>
                            <th class="py-3 px-6 text-left">Adresse</th>
                            <th class="py-3 px-6 text-center">Telefon</th>
                            <th class="py-3 px-6 text-center">Tag</th>
                            <th class="py-3 px-6 text-center">Aktion</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="text-gray-600 text-sm font-light">
                        <tr><td colspan="6" class="text-center py-4">Laden...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCY9TmJwzoJRWFTAjhDFBD0eFMR4YKTHJQ",
            authDomain: "listapp-96713.firebaseapp.com",
            projectId: "listapp-96713",
            storageBucket: "listapp-96713.firebasestorage.app",
            messagingSenderId: "1044312662356",
            appId: "1:1044312662356:web:64fd48530c4238127828c1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // References
        const dbRef = collection(db, "customers");
        const bexioRef = collection(db, "bexio_contacts");

        const statusIndicator = document.getElementById('statusIndicator');
        const tableBody = document.getElementById('tableBody');
        const searchInput = document.getElementById('searchInput');
        
        // Autocomplete Elements
        const restaurantInput = document.getElementById('restaurant');
        const nameInput = document.getElementById('name');
        const addressInput = document.getElementById('address');
        const phoneInput = document.getElementById('phone');
        const suggestionsList = document.getElementById('suggestions');

        let globalCustomers = []; 
        let currentData = [];
        let bexioData = []; // Store Bexio contacts here

        // --- 1. LOAD BEXIO DATA (Once on startup) ---
        async function loadBexioData() {
            try {
                const snapshot = await getDocs(bexioRef);
                snapshot.forEach(doc => {
                    bexioData.push(doc.data());
                });
                console.log("Bexio Data Loaded:", bexioData.length);
            } catch (error) {
                console.error("Error loading Bexio:", error);
            }
        }
        loadBexioData();

        // --- 2. AUTOCOMPLETE LOGIC ---
        restaurantInput.addEventListener('input', function() {
            const val = this.value.toLowerCase();
            suggestionsList.innerHTML = '';
            
            if (!val || val.length < 2) {
                suggestionsList.classList.add('hidden');
                return;
            }

            // Search in Bexio Data (Restaurant OR Name)
            const matches = bexioData.filter(c => 
                (c.restaurant && c.restaurant.toLowerCase().includes(val)) || 
                (c.name && c.name.toLowerCase().includes(val))
            ).slice(0, 10); // Limit to 10 suggestions

            if (matches.length > 0) {
                suggestionsList.classList.remove('hidden');
                matches.forEach(match => {
                    const li = document.createElement('li');
                    // Display: Restaurant (Name)
                    let displayText = match.restaurant;
                    if(match.name) displayText += ` <span class="text-xs text-gray-500">(${match.name})</span>`;
                    
                    li.innerHTML = displayText;
                    
                    li.addEventListener('click', () => {
                        // Fill Form
                        restaurantInput.value = match.restaurant || "";
                        nameInput.value = match.name || "";
                        addressInput.value = match.address || "";
                        phoneInput.value = match.phone || "";
                        
                        // Highlight effects
                        addressInput.classList.add('bg-green-50');
                        phoneInput.classList.add('bg-green-50');
                        setTimeout(() => {
                            addressInput.classList.remove('bg-green-50');
                            phoneInput.classList.remove('bg-green-50');
                        }, 1000);

                        suggestionsList.classList.add('hidden');
                    });
                    suggestionsList.appendChild(li);
                });
            } else {
                suggestionsList.classList.add('hidden');
            }
        });

        // Hide suggestions if clicked outside
        document.addEventListener('click', function(e) {
            if (e.target !== restaurantInput) {
                suggestionsList.classList.add('hidden');
            }
        });


        // --- 3. MAIN APP LOGIC (Table, Add, etc.) ---
        const q = query(dbRef, orderBy("day")); 
        
        onSnapshot(q, (snapshot) => {
            statusIndicator.innerText = "Online";
            statusIndicator.className = "text-xs bg-green-500 text-white py-1 px-3 rounded-full";
            
            globalCustomers = []; 
            snapshot.forEach((docSnap) => {
                globalCustomers.push({ ...docSnap.data(), id: docSnap.id });
            });
            currentData = globalCustomers;
            
            if(searchInput.value) filterData(searchInput.value);
            else renderTable(currentData);
        }, (error) => {
            statusIndicator.innerText = "Fehler";
            statusIndicator.className = "text-xs bg-red-500 text-white py-1 px-3 rounded-full";
        });

        function renderTable(data) {
            tableBody.innerHTML = "";
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-400">Keine Daten gefunden.</td></tr>';
                return;
            }
            data.forEach((c) => {
                const row = `
                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                        <td class="py-3 px-6 text-left font-medium">${c.name}</td>
                        <td class="py-3 px-6 text-left">${c.restaurant}</td>
                        <td class="py-3 px-6 text-left text-xs">${c.address}</td>
                        <td class="py-3 px-6 text-center">${c.phone}</td>
                        <td class="py-3 px-6 text-center"><span class="bg-blue-200 text-blue-600 py-1 px-3 rounded-full text-xs">${c.day}</span></td>
                        <td class="py-3 px-6 text-center">
                            <button class="delete-btn text-red-500 hover:text-red-700 transform hover:scale-110" data-id="${c.id}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    deleteItem(id);
                });
            });
        }

        function filterData(term) {
            term = term.toLowerCase();
            currentData = globalCustomers.filter(c => 
                (c.restaurant && c.restaurant.toLowerCase().includes(term)) || 
                (c.day && c.day.toLowerCase().includes(term)) ||
                (c.name && c.name.toLowerCase().includes(term))
            );
            renderTable(currentData);
        }

        searchInput.addEventListener('input', (e) => filterData(e.target.value));

        document.getElementById('clientForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Speichern...';
            try {
                await addDoc(dbRef, {
                    name: nameInput.value,
                    restaurant: restaurantInput.value,
                    address: addressInput.value,
                    phone: phoneInput.value,
                    referer: document.getElementById('referer').value,
                    day: document.getElementById('day').value,
                    createdAt: new Date()
                });
                this.reset();
                searchInput.value = '';
                currentData = globalCustomers;
                renderTable(currentData);
            } catch (error) {
                alert("Fehler: " + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-plus-circle mr-2"></i> Speichern (Server)';
            }
        });

        window.deleteItem = async function(id) {
            if(confirm('LÃ¶schen?')) await deleteDoc(doc(db, "customers", id));
        }

        window.exportCSV = function() {
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += "Name,Restaurant,Adresse,Telefon,Referenz,Liefertag\n";
            currentData.forEach(c => {
                csvContent += `"${c.name}","${c.restaurant}","${c.address}","${c.phone}","${c.referer}","${c.day}"\n`;
            });
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "liste.csv");
            document.body.appendChild(link);
            link.click();
        }

        window.exportPDF = function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: "landscape" });
            let title = "Kundenliste";
            if(searchInput.value) title += " (Suche: " + searchInput.value + ")";
            doc.text(title, 14, 20);
            
            const tableColumn = ["Name", "Restaurant", "Adresse", "Telefon", "Referenz", "Tag"];
            const tableRows = [];
            currentData.forEach(c => {
                tableRows.push([c.name, c.restaurant, c.address, c.phone, c.referer, c.day]);
            });
            doc.autoTable({ head: [tableColumn], body: tableRows, startY: 30 });
            doc.save("liste.pdf");
        }
    </script>
</body>
</html>
